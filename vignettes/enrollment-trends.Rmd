---
title: "Georgia Enrollment Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Georgia Enrollment Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 10,
  fig.height = 6,
  out.width = "100%",
  message = FALSE,
  warning = FALSE
)
```

## Getting Started

```{r load-packages}
library(gaschooldata)
library(ggplot2)
library(dplyr)
library(scales)
```

## Data Availability

Check which years are available:

```{r years}
years <- get_available_years()
print(years)
```

## Fetching Enrollment Data

Fetch enrollment data for the most recent year:

```{r fetch}
enr <- fetch_enr(years$max_year)

# Data structure
cat("Rows:", nrow(enr), "\n")
cat("Columns:", ncol(enr), "\n\n")

# Detail levels (State, District, School)
cat("Detail levels:\n")
print(table(enr$DETAIL_LVL_DESC))
```

## Data Structure

The data includes demographic breakdowns for state, district, and school levels:

```{r structure}
# Key columns
key_cols <- c("DETAIL_LVL_DESC", "SCHOOL_DSTRCT_NM", "INSTN_NAME",
              "ENROLL_PCT_WHITE", "ENROLL_PCT_BLACK", "ENROLL_PCT_HISPANIC",
              "ENROLL_PCT_ASIAN", "ENROLL_PCT_MALE", "ENROLL_PCT_FEMALE")

# View state-level data
state_data <- enr %>%
  filter(DETAIL_LVL_DESC == "State") %>%
  select(all_of(key_cols[key_cols %in% names(enr)]))

knitr::kable(state_data, caption = "State-Level Demographics")
```

## Visualizing Demographics

```{r demo-plot}
# Get state demographics
state <- enr %>%
  filter(DETAIL_LVL_DESC == "State")

# Extract percentages
demographics <- data.frame(
  group = c("White", "Black", "Hispanic", "Asian", "Other"),
  pct = as.numeric(c(
    state$ENROLL_PCT_WHITE,
    state$ENROLL_PCT_BLACK,
    state$ENROLL_PCT_HISPANIC,
    state$ENROLL_PCT_ASIAN,
    100 - sum(as.numeric(c(
      state$ENROLL_PCT_WHITE,
      state$ENROLL_PCT_BLACK,
      state$ENROLL_PCT_HISPANIC,
      state$ENROLL_PCT_ASIAN
    )), na.rm = TRUE)
  ))
)

ggplot(demographics, aes(x = reorder(group, -pct), y = pct, fill = group)) +
  geom_col() +
  labs(title = "Georgia Public School Demographics",
       subtitle = paste("School Year", years$max_year - 1, "-", substr(years$max_year, 3, 4)),
       x = "", y = "Percent of Students") +
  theme_minimal() +
  theme(legend.position = "none")
```

## Largest Districts

```{r districts}
# Note: The raw data doesn't have total enrollment as a single column
# For now, we'll just show district names

districts <- enr %>%
  filter(DETAIL_LVL_DESC == "District") %>%
  head(10) %>%
  select(SCHOOL_DSTRCT_NM, ENROLL_PCT_WHITE, ENROLL_PCT_BLACK, ENROLL_PCT_HISPANIC)

knitr::kable(districts, caption = "Sample District Demographics")
```

## Grade-Level Enrollment

If grade data is available, it will appear as columns like `GRADE_K`, `GRADE_1st`, etc.:

```{r grades}
grade_cols <- grep("^GRADE_", names(enr), value = TRUE)

if (length(grade_cols) > 0) {
  cat("Grade-level enrollment columns available:\n")
  print(grade_cols)

  # State-level grade enrollment
  state <- enr %>% filter(DETAIL_LVL_DESC == "State")
  grades <- data.frame(
    grade = grade_cols,
    count = sapply(grade_cols, function(g) as.numeric(state[[g]]))
  )
  grades$grade <- gsub("GRADE_", "", grades$grade)

  ggplot(grades, aes(x = grade, y = count)) +
    geom_col(fill = "steelblue") +
    labs(title = "Enrollment by Grade Level",
         x = "Grade", y = "Students") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
} else {
  cat("Grade-level data not available for this year.\n")
}
```

## Multi-Year Analysis

Fetch multiple years for trend analysis:

```{r multi-year, eval = FALSE}
# Fetch last 3 years (this may take a while)
enr_multi <- fetch_enr_multi((years$max_year - 2):years$max_year)
```

## Data Source

Data is sourced from the Georgia Governor's Office of Student Achievement (GOSA):

- Website: https://gosa.georgia.gov/
- Download repository: https://download.gosa.ga.gov/

See the package documentation for more details on data availability and structure.
